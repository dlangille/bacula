<%@ MasterClass="Application.Web.Layouts.Main" Theme="Baculum-v2"%>
<com:TContent ID="Main">
	<!-- Header -->
	<header class="w3-container">
		<h5>
			<b><i class="fa fa-lock"></i> <%[ Security ]%></b>
		</h5>
	</header>
	<div class="w3-bar w3-green w3-margin-bottom">
		<button id="btn_user_security" type="button" class="w3-bar-item w3-button tab_btn w3-grey" onclick="W3Tabs.open(this.id, 'user_security');"><%[ Settings ]%></button>
		<button id="btn_user_list" type="button" class="w3-bar-item w3-button tab_btn" onclick="W3Tabs.open(this.id, 'user_list'); oUserList.table.responsive.recalc();"><%[ Users ]%></button>
		<button id="btn_role_list" type="button" class="w3-bar-item w3-button tab_btn" onclick="W3Tabs.open(this.id, 'role_list'); oRoleList.table.responsive.recalc();"><%[ Roles ]%></button>
	</div>

	<div class="w3-container tab_item" id="user_security">
		<h4><%[ General settings ]%></h4>
		<p><%[ Default access setting for logged in users not defined in Baculum Web: ]%></p>
		<div class="w3-container w3-row w3-padding opt_row">
			<div class="w3-col" style="width: 40px">
				<com:TRadioButton
					ID="GeneralDefaultNoAccess"
					GroupName="GeneralDefault"
					CssClass="w3-radio"
					Attributes.onclick="document.getElementById('general_options_default_access').style.display = 'none';"
				/>
			</div>
			<label for="<%=$this->GeneralDefaultNoAccess->ClientID%>"><%[ No access ]%></label>
		</div>
		<div class="w3-container w3-row w3-padding opt_row">
			<div class="w3-col" style="width: 40px">
				<com:TRadioButton
					ID="GeneralDefaultAccess"
					GroupName="GeneralDefault"
					CssClass="w3-radio"
					Attributes.onclick="document.getElementById('general_options_default_access').style.display = '';"
				/>
			</div>
			<label for="<%=$this->GeneralDefaultAccess->ClientID%>"><%[ Access with default settings ]%></label>
		</div>
		<div id="general_options_default_access" class="w3-container w3-margin-left" style="display: <%=$this->GeneralDefaultAccess->Checked ? 'block' : 'none'%>">
			<div class="w3-half">
				<div class="w3-container w3-row w3-padding w3-block">
					<div class="w3-third w3-col">
						<%[ Default role: ]%>
					</div>
					<div class="w3-twothird w3-col">
						<com:TActiveDropDownList
							ID="GeneralDefaultAccessRole"
							CssClass="w3-input w3-border"
							CausesValidation="false"
							Width="90%"
						/>
					</div>
				</div>
				<div class="w3-container w3-row w3-padding">
					<div class="w3-third w3-col">
						<%[ Default API host: ]%>
					</div>
					<div class="w3-twothird w3-col">
						<com:TActiveDropDownList
							ID="GeneralDefaultAccessAPIHost"
							CssClass="w3-input w3-border"
							CausesValidation="false"
							Width="90%"
						/>
					</div>
				</div>
			</div>
		</div>

		<h4><%[ Authentication method ]%></h4>
		<div class="w3-container w3-row w3-padding opt_row">
			<div class="w3-col" style="width: 40px">
				<com:TRadioButton
					ID="BasicAuth"
					GroupName="AuthMethod"
					CssClass="w3-radio"
					Attributes.onclick="oUserSecurity.select_auth_method('basic');"
				/>
			</div>
			<label for="<%=$this->BasicAuth->ClientID%>"><%[ HTTP Basic authentication ]%></label>
		</div>
		<div id="authentication_method_basic" class="w3-container" style="display: none">
			<%[ This type of authentication is realized by web server. To use it, the basic authentication has to be enabled in the Baculum Web web server configuration. ]%>
			<div>
				<div class="w3-container w3-row w3-padding opt_row">
					<div class="w3-col" style="width: 40px">
						<com:TCheckBox
							ID="BasicAuthAllowManageUsers"
							CssClass="w3-check"
						/>
					</div>
					<label for="<%=$this->BasicAuthAllowManageUsers->ClientID%>"><%[ Allow Baculum Web to manage the Basic authentication users (add/remove users and change their passwords) ]%></label>
				</div>
				<div class="w3-container w3-row w3-padding w3-block">
					<div class="w3-col opt_row" style="width: 220px">
						<%[ Users file path: ]%>
					</div>
					<div class="w3-twothird w3-col">
						<com:TActiveTextBox
							ID="BasicAuthUserFile"
							CssClass="w3-input w3-border w3-show-inline-block"
							CausesValidation="false"
							Width="400px"
						/><com:TActiveLinkButton
							ValidationGroup="AuthMethodGroup"
							CausesValidation="true"
							CssClass="w3-button w3-green"
							OnCallback="doBasicUserFileTest"
						>
							<i class="fas fa-play"></i> &nbsp;<%[ Test ]%>
							<prop:ClientSide.OnLoading>
								document.getElementById('basic_auth_user_file_test_ok').style.display = 'none';
								document.getElementById('basic_auth_user_file_test_error').style.display = 'none';
								document.getElementById('basic_auth_user_file_test_loading').style.visibility = 'visible';
								document.getElementById('<%=$this->BasicAuthUserFileMsg->ClientID%>').style.display = 'none';
							</prop:ClientSide.OnLoading>
							<prop:ClientSide.OnComplete>
								document.getElementById('basic_auth_user_file_test_loading').style.visibility = 'hidden';
								document.getElementById('<%=$this->BasicAuthUserFileMsg->ClientID%>').style.display = '';
							</prop:ClientSide.OnComplete>
						</com:TActiveLinkButton>
						&nbsp;<i id="basic_auth_user_file_test_loading" class="fas fa-sync w3-spin" style="visibility: hidden;"></i>
						<span id="basic_auth_user_file_test_ok" class="w3-text-green" style="display: none;"><i class="fas fa-check w3-text-green"></i> &nbsp;<%[ OK ]%></span>
						<div>
							<i id="basic_auth_user_file_test_error" class="fas fa-times-circle w3-text-red" style="display: none;"></i>
							<com:TActiveLabel
								ID="BasicAuthUserFileMsg"
								CssClass="error"
								ActiveControl.EnableUpdate="true"
							/>
							<com:TRequiredFieldValidator
								ValidationGroup="AuthMethodGroup"
								CssClass="validator-block"
								ControlCssClass="field_invalid"
								Display="Dynamic"
								ControlToValidate="BasicAuthUserFile"
								Text="<%[ Please enter users file path value. ]%>"
							>
								<prop:ClientSide.OnValidate>
									var basic_auth_opt = $('#<%=$this->BasicAuth->ClientID%>')[0];
									var user_file_opt = $('#<%=$this->BasicAuthAllowManageUsers->ClientID%>')[0];
									sender.enabled = (basic_auth_opt.checked && user_file_opt.checked);
								</prop:ClientSide.OnValidate>
							</com:TRequiredFieldValidator>
						</div>
					</div>
				</div>
				<div class="w3-container w3-row w3-padding w3-block">
					<div class="w3-col opt_row" style="width: 220px">
						<%[  Hash algorithm: ]%>
					</div>
					<div class="w3-twothird w3-col">
						<com:TActiveDropDownList
							ID="BasicAuthHashAlgorithm"
							CssClass="w3-select w3-border"
							CausesValidation="false"
							Width="180px"
							Attributes.onchange="basic_auth_change_hash_alg(this.value);"
						>
							<com:TListItem Value="apr1-md5" Text="APR1-MD5" />
							<com:TListItem Value="sha1" Text="SHA-1" />
							<com:TListItem Value="sha256" Text="SHA-256" />
							<com:TListItem Value="sha512" Text="SHA-512" />
							<com:TListItem Value="ssha1" Text="SSHA (salted SHA-1)" />
							<com:TListItem Value="bcrypt" Text="BCrypt" />
						</com:TActiveDropDownList>
						<span id="basic_auth_alg_supp_msg"></span>
					</div>
					<script>
						function basic_auth_change_hash_alg(alg) {
							var msg = '<%[ Requried support from web server side - e.g. %supported_web_server_list ]%>'
							var hash_alg_supp = {
								'apr1-md5': [
									'Apache',
									'Lighttpd 1.4.13+',
									'Nginx 1.0.3+'
								],
								'sha1': [
									'Apache',
									'Lighttpd 1.4.33+',
									'Nginx 1.3.13+'
								],
								'sha256': [
									'<%[ Apache, Lighttpd and Nginx on most UNIX platforms ]%>',
								],
								'sha512': [
									'<%[ Apache, Lighttpd and Nginx on most UNIX platforms ]%>',
								],
								'ssha1': [
									'Nginx 1.0.3+'
								],
								'bcrypt': [
									'<%[ Apache 2.4 with apr-util 1.5+ ]%>',
									'<%[ Nginx on most UNIX platforms ]%>'
								]
							};
							msg = msg.replace('%supported_web_server_list',  hash_alg_supp[alg].join(', '));
							document.getElementById('basic_auth_alg_supp_msg').textContent = '( ' + msg + ' )';
						}
						var basic_auth_hash_alg_sel_val = document.getElementById('<%=$this->BasicAuthHashAlgorithm->ClientID%>').value;
						basic_auth_change_hash_alg(basic_auth_hash_alg_sel_val);
					</script>
				</div>
			</div>
			<div class="w3-container">
				<com:TActiveLinkButton
					ValidationGroup="AuthMethodGroup"
					CausesValidation="true"
					OnCommand="getBasicUsers"
					CommandParameter="load"
					CssClass="w3-button w3-section w3-green w3-padding"
				>
					<i class="fa fa-users"></i> &nbsp;<%[ Manage Basic users ]%>
					<prop:ClientSide.OnLoading>
						document.getElementById('basic_get_users_ok').style.display = 'none';
						document.getElementById('basic_get_users_error').style.display = 'none';
						document.getElementById('basic_get_users_loading').style.visibility = 'visible';
						oUserSecurity.show_user_selected_msg(false);
					</prop:ClientSide.OnLoading>
					<prop:ClientSide.OnComplete>
						document.getElementById('basic_get_users_loading').style.visibility = 'hidden';
					</prop:ClientSide.OnComplete>
				</com:TActiveLinkButton>
				&nbsp;<i id="basic_get_users_loading" class="fas fa-sync w3-spin" style="visibility: hidden;"></i>
				<span id="basic_get_users_ok" class="w3-text-green" style="display: none;"><i class="fas fa-check w3-text-green"></i> &nbsp;<%[ OK ]%></span>
				<i id="basic_get_users_error" class="fas fa-times-circle w3-text-red" style="display: none;"></i>
				<com:TActiveLabel ID="TestBasicGetUsersMsg" CssClass="w3-text-red" Display="None" />
			</div>
		</div>
		<div class="w3-container w3-row w3-padding opt_row">
			<div class="w3-col" style="width: 40px">
				<com:TRadioButton
					ID="LdapAuth"
					GroupName="AuthMethod"
					CssClass="w3-radio"
					Attributes.onclick="oUserSecurity.select_auth_method('ldap');"
				/>
			</div>
			<label for="<%=$this->LdapAuth->ClientID%>"><%[ LDAP authentication ]%></label>
		</div>
		<div id="authentication_method_ldap" class="w3-container w3-half w3-margin-left" style="display: none">
			<h5><%[ LDAP server options ]%></h5>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ IP Address/Hostname: ]%>
				</div>
				<div class="w3-twothird w3-col">
					<com:TActiveTextBox
						ID="LdapAuthServerAddress"
						CssClass="w3-input w3-border w3-show-inline-block"
						CausesValidation="false"
						Width="90%"
					/>
					<i class="fas fa-asterisk w3-text-red opt_req"></i>
					<com:TRequiredFieldValidator
						ValidationGroup="AuthMethodGroup"
						CssClass="validator-block"
						Display="Dynamic"
						ControlCssClass="field_invalid"
						ControlToValidate="LdapAuthServerAddress"
						Text="<%[ Please enter IP Address/Hostname. ]%>"
					>
						<prop:ClientSide.OnValidate>
							sender.enabled = $('#<%=$this->LdapAuth->ClientID%>')[0].checked;
						</prop:ClientSide.OnValidate>
					</com:TRequiredFieldValidator>
				</div>
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ Port: ]%>
				</div>
				<div class="w3-col" style="width: 245px;">
					<com:TActiveTextBox
						ID="LdapAuthServerPort"
						CssClass="w3-input w3-border w3-show-inline-block"
						CausesValidation="false"
						Width="70px"
						Text="389"
					/>
					<i class="fas fa-asterisk w3-text-red opt_req"></i><br />
					<com:TRequiredFieldValidator
						ValidationGroup="AuthMethodGroup"
						CssClass="validator-block"
						Display="Dynamic"
						ControlCssClass="field_invalid"
						ControlToValidate="LdapAuthServerPort"
						Text="<%[ Please enter port. ]%>"
					>
						<prop:ClientSide.OnValidate>
							sender.enabled = $('#<%=$this->LdapAuth->ClientID%>')[0].checked;
						</prop:ClientSide.OnValidate>
					</com:TRequiredFieldValidator>
				</div>
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ SSL encryption (LDAPS): ]%>
				</div>
				<div class="w3-col" style="width: 70px;">
					<com:TActiveCheckBox
						ID="LdapAuthServerLdaps"
						CssClass="w3-check w3-border"
						CausesValidation="false"
						AutoPostBack="false"
					/>
				</div>
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ Protocol version: ]%>
				</div>
				<div class="w3-col" style="width: 160px">
					<com:TActiveDropDownList
						ID="LdapAuthServerProtocolVersion"
						CssClass="w3-input w3-border"
						CausesValidation="false"
						AutoPostBack="false"
					>
						<com:TListItem Value="1" Text="LDAP version 1" />
						<com:TListItem Value="2" Text="LDAP version 2" />
						<com:TListItem Value="3" Text="LDAP version 3" Selected="true" />
					</com:TActiveDropDownList>
				</div>
			</div>
			<h5><%[ LDAP authentication method ]%></h5>
			<div class="w3-container w3-row w3-padding opt_row">
				<div class="w3-col" style="width: 40px">
					<com:TRadioButton
						ID="LdapAuthMethodAnonymous"
						GroupName="LdapAuthMethod"
						CssClass="w3-radio"
						Attributes.onclick="oLdapUserSecurity.show_ldap_auth('anon');"
						Checked="true"
					/>
				</div>
				<label for="<%=$this->LdapAuthMethodAnonymous->ClientID%>"><%[ Anonymous authentication ]%></label>
			</div>
			<div class="w3-container w3-row w3-padding opt_row">
				<div class="w3-col" style="width: 40px">
					<com:TRadioButton
						ID="LdapAuthMethodSimple"
						GroupName="LdapAuthMethod"
						CssClass="w3-radio"
						Attributes.onclick="oLdapUserSecurity.show_ldap_auth('simple');"
					/>
				</div>
				<label for="<%=$this->LdapAuthMethodSimple->ClientID%>"><%[ Simple authentication ]%></label>
			</div>
			<div id="authentication_method_ldap_auth_simple" class="w3-container w3-margin-left" style="display: <%=$this->LdapAuthMethodSimple->Checked ? 'block' : 'none'%>">
				<div class="w3-container w3-row w3-padding">
					<div class="w3-third w3-col">
						<%[ Manager DN: ]%>
					</div>
					<div class="w3-twothird w3-col">
						<com:TActiveTextBox
							ID="LdapAuthMethodSimpleUsername"
							CssClass="w3-input w3-border w3-show-inline-block"
							CausesValidation="false"
							Width="90%"
						/>
						<i class="fas fa-asterisk w3-text-red opt_req"></i>
						<com:TRequiredFieldValidator
							ValidationGroup="AuthMethodGroup"
							CssClass="validator-block"
							Display="Dynamic"
							ControlCssClass="field_invalid"
							ControlToValidate="LdapAuthMethodSimpleUsername"
							Text="<%[ Please enter username. ]%>"
						>
							<prop:ClientSide.OnValidate>
								var is_ldap_auth = $('#<%=$this->LdapAuth->ClientID%>')[0].checked;
								var is_auth_simple = $('#<%=$this->LdapAuthMethodSimple->ClientID%>')[0].checked;
								sender.enabled = (is_ldap_auth && is_auth_simple);
							</prop:ClientSide.OnValidate>
						</com:TRequiredFieldValidator>
					</div>
				</div>
				<div class="w3-container w3-row w3-padding">
					<div class="w3-third w3-col">
						<%[ Password: ]%>
					</div>
					<div class="w3-twothird w3-col">
						<com:TActiveTextBox
							ID="LdapAuthMethodSimplePassword"
							CssClass="w3-input w3-border w3-show-inline-block"
							CausesValidation="false"
							TextMode="Password"
							PersistPassword="true"
							Width="90%"
						/>
						<i class="fas fa-asterisk w3-text-red opt_req"></i>
						<com:TRequiredFieldValidator
							ValidationGroup="AuthMethodGroup"
							CssClass="validator-block"
							Display="Dynamic"
							ControlCssClass="field_invalid"
							ControlToValidate="LdapAuthMethodSimplePassword"
							Text="<%[ Please enter password. ]%>"
						>
							<prop:ClientSide.OnValidate>
								var is_ldap_auth = $('#<%=$this->LdapAuth->ClientID%>')[0].checked;
								var is_auth_simple = $('#<%=$this->LdapAuthMethodSimple->ClientID%>')[0].checked;
								sender.enabled = (is_ldap_auth && is_auth_simple);
							</prop:ClientSide.OnValidate>
						</com:TRequiredFieldValidator>
					</div>
				</div>
			</div>
			<div class="w3-container">
				<com:TActiveLinkButton
					ID="LdapAuthServerConnectionTest"
					ValidationGroup="AuthMethodGroup"
					CausesValidation="true"
					OnCallback="testLdapConnection"
					CssClass="w3-button w3-section w3-green w3-padding"
				>
					<i class="fa fa-plug"></i> &nbsp;<%[ Test LDAP connection ]%>
					<prop:ClientSide.OnLoading>
						document.getElementById('ldap_test_connection_ok').style.display = 'none';
						document.getElementById('ldap_test_connection_error').style.display = 'none';
						document.getElementById('ldap_test_connection_loading').style.visibility = 'visible';
					</prop:ClientSide.OnLoading>
					<prop:ClientSide.OnComplete>
						document.getElementById('ldap_test_connection_loading').style.visibility = 'hidden';
					</prop:ClientSide.OnComplete>
				</com:TActiveLinkButton>
				&nbsp;<i id="ldap_test_connection_loading" class="fas fa-sync w3-spin" style="visibility: hidden;"></i>
				<span id="ldap_test_connection_ok" class="w3-text-green" style="display: none;"><i class="fas fa-check w3-text-green"></i> &nbsp;<%[ OK ]%></span>
				<i id="ldap_test_connection_error" class="fas fa-times-circle w3-text-red" style="display: none;"></i>
				<com:TActiveLabel ID="TestLdapConnectionMsg" CssClass="w3-text-red" Display="None" />
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ Base DN: ]%>
				</div>
				<div class="w3-twothird w3-col">
					<com:TActiveTextBox
						ID="LdapAuthServerBaseDn"
						CssClass="w3-input w3-border w3-show-inline-block"
						CausesValidation="false"
						Width="90%"
					/>
					<i class="fas fa-asterisk w3-text-red opt_req"></i><br />
					<com:TRequiredFieldValidator
						ValidationGroup="AuthMethodGroup"
						CssClass="validator-block"
						Display="Dynamic"
						ControlCssClass="field_invalid"
						ControlToValidate="LdapAuthServerBaseDn"
						Text="<%[ Please enter Base DN. ]%>"
					>
						<prop:ClientSide.OnValidate>
							var is_test_con = (parameter && parameter.options.ID == '<%=$this->LdapAuthServerConnectionTest->ClientID%>');
							var is_ldap_enabled = $('#<%=$this->LdapAuth->ClientID%>')[0].checked;
							sender.enabled = (!is_test_con && is_ldap_enabled);
						</prop:ClientSide.OnValidate>
					</com:TRequiredFieldValidator>
				</div>
			</div>
			<h5><%[ Attributes ]%></h5>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ Username: ]%>
				</div>
				<div class="w3-twothird w3-col">
					<com:TActiveTextBox
						ID="LdapAttributesUsername"
						CssClass="w3-input w3-border w3-show-inline-block"
						CausesValidation="false"
						Text="uid"
						Width="90%"
					/>
					<i class="fas fa-asterisk w3-text-red opt_req"></i>
					<com:TRequiredFieldValidator
						ValidationGroup="AuthMethodGroup"
						CssClass="validator-block"
						Display="Dynamic"
						ControlCssClass="field_invalid"
						ControlToValidate="LdapAttributesUsername"
						Text="<%[ Please enter username attribute. ]%>"
					>
						<prop:ClientSide.OnValidate>
							sender.enabled = $('#<%=$this->LdapAuth->ClientID%>')[0].checked;
						</prop:ClientSide.OnValidate>
					</com:TRequiredFieldValidator>
				</div>
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ Long name: ]%>
				</div>
				<div class="w3-twothird w3-col">
					<com:TActiveTextBox
						ID="LdapAttributesLongName"
						CssClass="w3-input w3-border"
						CausesValidation="false"
						Text="sn"
						Width="90%"
					/>
				</div>
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ E-mail: ]%>
				</div>
				<div class="w3-twothird w3-col">
					<com:TActiveTextBox
						ID="LdapAttributesEmail"
						CssClass="w3-input w3-border"
						CausesValidation="false"
						Text="mail"
						Width="90%"
					/>
				</div>
			</div>
			<div class="w3-container w3-row w3-padding">
				<div class="w3-third w3-col">
					<%[ Description: ]%>
				</div>
				<div class="w3-twothird w3-col">
					<com:TActiveTextBox
						ID="LdapAttributesDescription"
						CssClass="w3-input w3-border"
						CausesValidation="false"
						Width="90%"
					/>
				</div>
			</div>
			<div class="w3-container">
				<com:TActiveLinkButton
					ValidationGroup="AuthMethodGroup"
					CausesValidation="true"
					OnCommand="getLdapUsers"
					CommandParameter="load"
					CssClass="w3-button w3-section w3-green w3-padding"
				>
					<i class="fa fa-users"></i> &nbsp;<%[ Manage LDAP users ]%>
					<prop:ClientSide.OnLoading>
						document.getElementById('ldap_get_users_ok').style.display = 'none';
						document.getElementById('ldap_get_users_error').style.display = 'none';
						document.getElementById('ldap_get_users_loading').style.visibility = 'visible';
						oUserSecurity.show_user_selected_msg(false);
					</prop:ClientSide.OnLoading>
					<prop:ClientSide.OnComplete>
						document.getElementById('ldap_get_users_loading').style.visibility = 'hidden';
					</prop:ClientSide.OnComplete>
				</com:TActiveLinkButton>
				&nbsp;<i id="ldap_get_users_loading" class="fas fa-sync w3-spin" style="visibility: hidden;"></i>
				<span id="ldap_get_users_ok" class="w3-text-green" style="display: none;"><i class="fas fa-check w3-text-green"></i> &nbsp;<%[ OK ]%></span>
				<i id="ldap_get_users_error" class="fas fa-times-circle w3-text-red" style="display: none;"></i>
				<com:TActiveLabel ID="TestLdapGetUsersMsg" CssClass="w3-text-red" Display="None" />
			</div>
		</div>
		<div class="w3-container w3-center">
			<com:TActiveLinkButton
				ID="AuthMethodSave"
				ValidationGroup="AuthMethodGroup"
				CausesValidation="true"
				OnCallback="saveSecurityConfig"
				CssClass="w3-button w3-section w3-green w3-padding"
			>
				<i class="fa fa-save"></i> &nbsp;<%[ Save ]%>
				<prop:ClientSide.OnLoading>
					document.getElementById('auth_method_save_ok').style.display = 'none';
					document.getElementById('auth_method_save_error').style.display = 'none';
					document.getElementById('auth_method_save_loading').style.visibility = 'visible';
				</prop:ClientSide.OnLoading>
				<prop:ClientSide.OnComplete>
					document.getElementById('auth_method_save_loading').style.visibility = 'hidden';
				</prop:ClientSide.OnComplete>
			</com:TActiveLinkButton>
			&nbsp;<i id="auth_method_save_loading" class="fas fa-sync w3-spin" style="visibility: hidden;"></i>
			<span id="auth_method_save_ok" class="w3-text-green" style="display: none;"><i class="fas fa-check w3-text-green"></i> &nbsp;<%[ OK ]%></span>
			<span id="auth_method_save_error" class="w3-text-red" style="display: none"><i class="fas fa-times-circle w3-text-red"></i><%[ Error ]%></span>
		</div>

		<div id="get_users_modal" class="w3-modal" style="display: none">
			<div class="w3-modal-content w3-card-4 w3-animate-zoom" style="width: 990px">
				<header class="w3-container w3-green">
					<span onclick="oUserSecurity.show_user_modal(false);" class="w3-button w3-display-topright">Ã—</span>
					<h2 id="get_users_table_title"></h2>
				</header>
				<div class="w3-margin-left w3-margin-right" style="max-height: 645px; overflow-x: auto; margin: 10px auto;">
					<table id="get_users_table" class="w3-table w3-striped w3-hoverable w3-white w3-margin-bottom selectable" style="width: 100%;">
						<thead>
							<tr>
								<th><%[ Username ]%></th>
								<th class="w3-center"><%[ Long name ]%></th>
								<th class="w3-center"><%[ Description ]%></th>
								<th class="w3-center"><%[ E-mail ]%></th>
							</tr>
						</thead>
						<tbody id="get_users_body"></tbody>
						<tfoot>
							<tr>
								<th><%[ Username ]%></th>
								<th class="w3-center"><%[ Long name ]%></th>
								<th class="w3-center"><%[ Description ]%></th>
								<th class="w3-center"><%[ E-mail ]%></th>
							</tr>
						</tfoot>
					</table>
					<p class="info w3-hide-medium w3-hide-small" style="margin: 4px 0;"><%[ Tip: Use left-click to select table row. Use CTRL + left-click to multiple row selection. Use SHIFT + left-click to add a range of rows to selection. ]%></p>
				</div>
				<footer class="w3-container w3-border-top">
					<div style="padding-top: 10px">
						<%[ Import options: ]%> <com:TActiveDropDownList
							ID="GetUsersImportOptions"
							CssClass="w3-select w3-border w3-show-inline-block"
							AutoPostBack="false"
							Width="250px"
						>
							<com:TListItem Value="0" Text="<%[ Import all users ]%>" />
							<com:TListItem Value="1" Text="<%[ Import selected users ]%>" />
							<com:TListItem Value="2" Text="<%[ Import users whose fulfill criteria ]%>" />
						</com:TActiveDropDownList>
						<div id="get_users_criteria" style="display: none;">
							<%[ Criteria filter: ]%>
							<com:TActiveDropDownList
								ID="GetUsersCriteria"
								CssClass="w3-select w3-border w3-show-inline-block"
								AutoPostBack="false"
								Width="150px"
							>
								<com:TListItem Attributes.id="get_users_criteria_filter_username" Value="0" Text="<%[ Username ]%>" />
								<com:TListItem Attributes.id="get_users_criteria_filter_long_name" Value="1" Text="<%[ Long name ]%>" />
								<com:TListItem Attributes.id="get_users_criteria_filter_desc" Value="2" Text="<%[ Description ]%>" />
								<com:TListItem Attributes.id="get_users_criteria_filter_email" Value="3" Text="<%[ E-mail ]%>" />
							</com:TActiveDropDownList>
							<%[ contains: ]%>
							<com:TActiveTextBox
								ID="GetUsersCriteriaFilter"
								CssClass="w3-input w3-border w3-show-inline-block"
								Width="130px"
								Attributes.onkeypress="oUserSecurity.on_reload_user_list(event);"
							/>
							<com:TActiveLinkButton
								ID="GetUsersCriteriaTest"
								CssClass="w3-button w3-green w3-show-inline-block"
								OnCallback="getUsers"
							>
								<i class="fa fa-sync-alt"></i> &nbsp;<%[ Reload ]%>
							</com:TActiveLinkButton>
						</div>
						<div id="get_users_selected_msg" style="display: none;">
							<%[ Please select users in table to import. ]%>
						</div>
					</div>
					<i class="fas fa-wrench"></i> &nbsp;<a href="javascript:void(0)" onclick="$('#get_users_advanced_options').toggle('fast');"><%[ Advanced options ]%></a>
					<div id="get_users_advanced_options" style="display: none">
						<div>
							<com:TActiveCheckBox
								ID="GetUsersProtectOverwrite"
								CssClass="w3-check"
								Checked="true"
								AutoPostBack="false"
							/>
							<label for="<%=$this->GetUsersProtectOverwrite->ClientID%>"><%[ Do not overwrite existing Baculum Web users, if they have the same username ]%></label>
						</div>
						<div class="w3-row w3-section">
							<div class="w3-col w3-third"><com:TLabel ForControl="GetUsersDefaultRole" Text="<%[ Default role for imported users: ]%>" /></div>
							<div class="w3-half">
								<com:TActiveListBox
									ID="GetUsersDefaultRole"
									SelectionMode="Multiple"
									Rows="6"
									CssClass="w3-select w3-border"
									AutoPostBack="false"
								/>
								<p class="w3-text-black" style="margin: 0 16px 0 0"><%[ Use CTRL + left-click to multiple item selection ]%></p>
								<com:TRequiredFieldValidator
									ValidationGroup="GetUsersGroup"
									ControlToValidate="GetUsersDefaultRole"
									ErrorMessage="<%[ At least one role must be selected. ]%>"
									ControlCssClass="field_invalid"
								/>
							</div> &nbsp;<i class="fa fa-asterisk w3-text-red opt_req"></i>
						</div>
						<div class="w3-row w3-section">
							<div class="w3-col w3-third"><com:TLabel ForControl="GetUsersDefaultAPIHost" Text="<%[ Default API host for imported users: ]%>" /></div>
							<div class="w3-half">
								<com:TActiveDropDownList
									ID="GetUsersDefaultAPIHost"
									CssClass="w3-select w3-border"
									AutoPostBack="false"
								/>
							</div>
						</div>
						<div class="w3-row w3-section" title="<%[ Comma separated IP addresses. Using asterisk character, there is also possible to provide subnet, for example: 192.168.1.* ]%>">
							<div class="w3-col w3-third"><com:TLabel ForControl="UserIps" Text="<%[ Default IP address restrictions for imported users: ]%>" /></div>
							<div class="w3-half">
								<com:TActiveTextBox
									ID="GetUsersDefaultIps"
									AutoPostBack="false"
									MaxLength="500"
									CssClass="w3-input w3-border"
								/>
								<p class="w3-text-black"><a href="javascript:void(0)" onclick="document.getElementById('<%=$this->GetUsersDefaultIps->ClientID%>').value = '<%=$_SERVER['REMOTE_ADDR']%>';"><%[ Set your IP address ]%></a></p>
								<com:TActiveCustomValidator
									ID="GetUsersDefaultIpsValidator"
									ValidationGroup="GetUsersGroup"
									ControlToValidate="GetUsersDefaultIps"
									OnServerValidate="validateIps"
									Display="Dynamic"
									ErrorMessage="<%[ Invalid IP address restrictions value. This field can have comma separated IP addresses only or subnet addresses like 192.168.1.* ]%>"
									ControlCssClass="field_invalid"
								/>
							</div>
						</div>
					</div>
					<div class="w3-center w3-margin-top w3-margin-bottom w3-border-top" style="padding-top: 10px;">
						<button type="button" class="w3-button w3-red" onclick="oUserSecurity.show_user_modal(false);"><i class="fa fa-times"></i> &nbsp;<%[ Close ]%></button>
						<com:TActiveLinkButton
							ID="GetUsersImport"
							CssClass="w3-button w3-green"
							CausesValidation="true"
							ValidationGroup="GetUsersGroup"
							OnCallback="importUsers"
							Attributes.onclick="return oUserSecurity.prepare_import();"
						>
							<prop:ClientSide.OnLoading>
								document.getElementById('get_users_loader').style.visibility = 'visible';
							</prop:ClientSide.OnLoading>
							<prop:ClientSide.OnComplete>
								document.getElementById('get_users_loader').style.visibility = 'hidden';
							</prop:ClientSide.OnComplete>
							<i class="fas fa-download"></i> &nbsp;<%[ Import users ]%>
						</com:TActiveLinkButton>
						<i id="get_users_loader" class="fa fa-sync w3-spin w3-margin-left" style="visibility: hidden"></i>
					</div>
				</footer>
			</div>
		</div>
<com:TCallback ID="SelectedUsersImport" OnCallback="TemplateControl.importUsers" />
<script>
var oUserSecurity = {
	ids: {
		auth_method_basic: 'authentication_method_basic',
		auth_method_ldap: 'authentication_method_ldap',
		get_users: 'get_users_table',
		get_users_body: 'get_users_body',
		get_users_modal: 'get_users_modal',
		get_users_selected_msg: 'get_users_selected_msg',
		get_users_criteria: 'get_users_criteria',
		get_users_criteria_test: '<%=$this->GetUsersCriteriaTest->ClientID%>',
		get_users_import_opts: '<%=$this->GetUsersImportOptions->ClientID%>',
		filter_long_name: 'get_users_criteria_filter_long_name',
		filter_desc: 'get_users_criteria_filter_desc',
		filter_email: 'get_users_criteria_filter_email',
		table_title: 'get_users_table_title'
	},
	import_options: {
		all_users: <%=Security::IMPORT_OPT_ALL_USERS%>,
		selected_users: <%=Security::IMPORT_OPT_SELECTED_USERS%>,
		criteria: <%=Security::IMPORT_OPT_CRITERIA%>
	},
	data: [],
	table: null,
	sel_users_import_cb: <%=$this->SelectedUsersImport->ActiveControl->Javascript%>,
	user_obj: null,
	init: function() {
		this.set_events();
	},
	select_auth_method: function(auth) {
		var auth_basic = document.getElementById(this.ids.auth_method_basic);
		var auth_ldap = document.getElementById(this.ids.auth_method_ldap);

		// hide all auth containers
		[auth_basic, auth_ldap].forEach(function(el) {
			el.style.display = 'none';
		});

		switch (auth) {
			case 'basic': {
				auth_basic.style.display = 'block';
				this.user_obj = oBasicUserSecurity;
				break;
			}
			case 'ldap': {
				auth_ldap.style.display = 'block';
				this.user_obj = oLdapUserSecurity;
				break;
			}
		}
	},
	set_events: function() {
		document.getElementById(this.ids.get_users).addEventListener('click', function(e) {
			$(function() {
				if (import_opts.value == this.import_options.selected_users) {
					var show = this.table.rows({selected: true}).data().length == 0;
					this.show_user_selected_msg(show);
				}
			}.bind(this));
		}.bind(this));
		var import_opts = document.getElementById(this.ids.get_users_import_opts);
		import_opts.addEventListener('change', function(e) {
			if (import_opts.value == this.import_options.criteria) {
				this.show_user_criteria(true);
			} else {
				this.show_user_criteria(false);
			}

			if (import_opts.value == this.import_options.selected_users && this.table.rows({selected: true}).data().length == 0) {
				this.show_user_selected_msg(true);
			} else {
				this.show_user_selected_msg(false);
			}
		}.bind(this));
	},
	set_table: function() {
		this.table = $('#' + this.ids.get_users).DataTable({
			data: this.data,
			deferRender: true,
			dom: 'lBfrtip',
			buttons: [
				'copy', 'csv', 'colvis'
			],
			columns: [
				{data: 'username'},
				{
					data: 'long_name',
					visible: (this.user_obj.supported_fields.indexOf('long_name') !== -1)
				},
				{
					data: 'description',
					visible: (this.user_obj.supported_fields.indexOf('description') !== -1)
				},
				{
					data: 'email',
					visible: (this.user_obj.supported_fields.indexOf('email') !== -1)
				}
			],
			responsive: {
				details: {
					type: 'column'
				}
			},
			columnDefs: [{
				className: "dt-center",
				targets: [ 1, 2, 3 ]
			}],
			select: {
				style:    'os',
				selector: 'td',
				blurable: false
			},
			order: [1, 'asc']
		});
	},
	destroy_table: function() {
		if (this.table) {
			this.table.destroy();
		}
	},
	prepare_import: function() {
		ret = true;
		var import_opts = document.getElementById(this.ids.get_users_import_opts);
		if (import_opts.value == this.import_options.selected_users) {
			var users = this.table.rows({selected: true}).data().toArray();
			this.sel_users_import_cb.setCallbackParameter(users);
			this.sel_users_import_cb.dispatch();
			ret = false; // to stop sending click event in original button
		}
		return ret;
	},
	set_user_table_cb: function(data, obj) {
		oUserSecurity.data = data;
		oUserSecurity.destroy_table();
		oUserSecurity.set_table();
		oUserSecurity.show_user_modal(true);
	},
	show_user_modal: function(show) {
		var modal = document.getElementById(oUserSecurity.ids.get_users_modal);
		if (show) {
			modal.style.display = 'block';
			if (this.user_obj) {
				this.user_obj.show_user_modal();
			}
		} else {
			modal.style.display = 'none';
		}
	},
	show_user_criteria: function(show) {
		document.getElementById(this.ids.get_users_criteria).style.display = (show ? 'inline-block' : 'none');
	},
	show_user_selected_msg: function(show) {
		document.getElementById(this.ids.get_users_selected_msg).style.display = (show ? 'inline-block' : 'none');
	},
	on_reload_user_list: function(e) {
		var x = e.which || e.keyCode;
		if (x === 13) {
			$('#' + this.ids.get_users_criteria_test).click();
		}
	}
};
var oBasicUserSecurity = {
	ids: {},
	name: 'basic',
	table_title: '<%[ Basic user list ]%>',
	supported_fields: ['username'],
	enabled: <%=$this->BasicAuth->Checked ? 'true' : 'false'%>,
	init: function() {
		jQuery.extend(this.ids, oUserSecurity.ids);
		if (this.enabled) {
			oUserSecurity.select_auth_method(this.name);
		}
	},
	show_user_modal: function() {
		document.getElementById(this.ids.table_title).textContent = this.table_title;
		document.getElementById(this.ids.filter_long_name).disabled = true;
		document.getElementById(this.ids.filter_desc).disabled = true;
		document.getElementById(this.ids.filter_email).disabled = true;
	}
};

var oLdapUserSecurity = {
	ids: {
		auth_simple: 'authentication_method_ldap_auth_simple',
	},
	name: 'ldap',
	table_title: '<%[ LDAP user list ]%>',
	supported_fields: ['username', 'long_name', 'description', 'email'],
	enabled: <%=$this->LdapAuth->Checked ? 'true' : 'false'%>,
	init: function() {
		jQuery.extend(this.ids, oUserSecurity.ids);
		if (this.enabled) {
			oUserSecurity.select_auth_method(this.name);
		}
	},
	show_ldap_auth: function(auth) {
		var auth_simple = document.getElementById(this.ids.auth_simple);
		auth_simple.style.display = (auth === 'simple') ? 'block' : 'none';
	},
	show_user_modal: function() {
		document.getElementById(this.ids.table_title).textContent = this.table_title;
		document.getElementById(this.ids.filter_long_name).disabled = false;
		document.getElementById(this.ids.filter_desc).disabled = false;
		document.getElementById(this.ids.filter_email).disabled = false;
	}
};

function validate_ips(sender, parameter) {
	return validate_comma_separated_list(parameter);
}
oUserSecurity.init();
oBasicUserSecurity.init();
oLdapUserSecurity.init();
</script>
	</div>
	<div class="w3-container tab_item" id="user_list" style="display: none">
		<div class="w3-panel">
			<button type="button" id="add_user_btn" class="w3-button w3-green" onclick="oUsers.load_user_window()"><i class="fa fa-plus"></i> &nbsp;<%[ Add new user ]%></a>
		</div>
		<table id="user_list_table" class="w3-table w3-striped w3-hoverable w3-white w3-margin-bottom selectable" style="width: 100%">
			<thead>
				<tr>
					<th></th>
					<th><%[ Username ]%></th>
					<th class="w3-center"><%[ Long name ]%></th>
					<th class="w3-center"><%[ Description ]%></th>
					<th class="w3-center"><%[ E-mail ]%></th>
					<th class="w3-center"><%[ Roles ]%></th>
					<th class="w3-center"><%[ API host ]%></th>
					<th class="w3-center"><%[ IP address restrictions ]%></th>
					<th class="w3-center"><%[ Enabled ]%></th>
					<th class="w3-center"><%[ Action ]%></th>
				</tr>
			</thead>
			<tbody id="user_list_body"></tbody>
			<tfoot>
				<tr>
					<th></th>
					<th><%[ Username ]%></th>
					<th class="w3-center"><%[ Long name ]%></th>
					<th class="w3-center"><%[ Description ]%></th>
					<th class="w3-center"><%[ E-mail ]%></th>
					<th class="w3-center"><%[ Roles ]%></th>
					<th class="w3-center"><%[ API host ]%></th>
					<th class="w3-center"><%[ IP address restrictions ]%></th>
					<th class="w3-center"><%[ Enabled ]%></th>
					<th class="w3-center"><%[ Action ]%></th>
				</tr>
			</tfoot>
		</table>
		<p class="info w3-hide-medium w3-hide-small"><%[ Tip: Use left-click to select table row. Use CTRL + left-click to multiple row selection. Use SHIFT + left-click to add a range of rows to selection. ]%></p>
<com:TCallback ID="UserList" OnCallback="TemplateControl.setUserList" />
<com:TCallback ID="LoadUser" OnCallback="TemplateControl.loadUserWindow" />
<com:TCallback ID="RemoveUsersAction" OnCallback="TemplateControl.removeUsers" />
<script>
var oUserList = {
	ids: {
		user_list: 'user_list_table',
		user_list_body: 'user_list_body'
	},
	actions: [
		{
			action: 'remove',
			label: '<%[ Remove ]%>',
			value: 'username',
			callback: <%=$this->RemoveUsersAction->ActiveControl->Javascript%>
		}
	],
	data: [],
	table: null,
	table_toolbar: null,
	init: function() {
		if (!this.table) {
			this.set_table();
			this.set_bulk_actions();
			this.set_events();
		} else {
			var page = this.table.page();
			this.table.clear().rows.add(this.data).draw();
			this.table.page(page).draw(false);
			oUserList.set_filters(this.table);
			this.table_toolbar.style.display = 'none';
		}
	},
	set_events: function() {
		document.getElementById(this.ids.user_list).addEventListener('click', function(e) {
			$(function() {
				this.table_toolbar.style.display = this.table.rows({selected: true}).data().length > 0 ? '' : 'none';
			}.bind(this));
		}.bind(this));
	},
	set_table: function() {
		this.table = $('#' + this.ids.user_list).DataTable({
			data: this.data,
			deferRender: true,
			dom: 'lB<"table_toolbar">frtip',
			stateSave: true,
			buttons: [
				'copy', 'csv', 'colvis'
			],
			columns: [
				{
					className: 'details-control',
					orderable: false,
					data: null,
					defaultContent: '<button type="button" class="w3-button w3-blue"><i class="fa fa-angle-down"></i></button>'
				},
				{data: 'username'},
				{data: 'long_name'},
				{
					data: 'description',
					visible: false
				},
				{
					data: 'email',
					visible: false
				},
				{data: 'roles'},
				{data: 'api_hosts'},
				{
					data: 'ips',
					visible: false
				},
				{
					data: 'enabled',
					render: function(data, type, row) {
						var ret;
						if (type == 'display') {
							ret = '';
							if (data == 1) {
								var check = document.createElement('I');
								check.className = 'fas fa-check';
								ret = check.outerHTML;
							}
						} else {
							ret = data;
						}
						return ret;
					}
				},
				{
					data: 'username',
					render: function (data, type, row) {
						var btn_edit = document.createElement('BUTTON');
						btn_edit.className = 'w3-button w3-green';
						btn_edit.type = 'button';
						var i_edit = document.createElement('I');
						i_edit.className = 'fa fa-list-ul';
						var label_edit = document.createTextNode(' <%[ Edit ]%>');
						btn_edit.appendChild(i_edit);
						btn_edit.innerHTML += '&nbsp';
						btn_edit.style.marginRight = '8px';
						btn_edit.appendChild(label_edit);
						btn_edit.setAttribute('onclick', 'oUsers.load_user_window(\'' + data + '\')');
						return btn_edit.outerHTML;
					}
				}
			],
			responsive: {
				details: {
					type: 'column'
				}
			},
			columnDefs: [{
				className: 'control',
				orderable: false,
				targets: 0
			},
			{
				className: 'action_col',
				orderable: false,
				targets: [ 9 ]
			},
			{
				className: "dt-center",
				targets: [ 5, 6, 8, 9 ]
			}],
			select: {
				style:    'os',
				selector: 'td:not(:last-child):not(:first-child)',
				blurable: false
			},
			order: [1, 'asc'],
			initComplete: function () {
				oUserList.set_filters(this.api());
			}
		});
	},
	set_filters: function(api) {
		api.columns([5, 6, 8]).every(function () {
			var column = this;
			var select = $('<select><option value=""></option></select>')
			.appendTo($(column.footer()).empty())
			.on('change', function () {
				var val = dtEscapeRegex(
					$(this).val()
				);
				column
				.search(val ? '^' + val + '$' : '', true, false)
				.draw();
			});
			if (column[0][0] == 8) { // Enabled column
				column.data().unique().sort().each(function (d, j) {
					var ds = '';
					if (d === '1') {
						ds = '<%[ Enabled ]%>';
					} else if (d === '0') {
						ds = '<%[ Disabled ]%>';
					}
					if (column.search() == '^' + dtEscapeRegex(d) + '$') {
						select.append('<option value="' + d + '" title="' + ds + '" selected>' + ds + '</option>');
					} else {
						select.append('<option value="' + d + '" title="' + ds + '">' + ds + '</option>');
					}
				});
			} else {
				column.cells('', column[0]).render('display').unique().sort().each(function(d, j) {
					if (column.search() == '^' + dtEscapeRegex(d) + '$') {
						select.append('<option value="' + d + '" selected>' + d + '</option>');
					} else if(d) {
						select.append('<option value="' + d + '">' + d + '</option>');
					}
				});
			}
		});
	},
	set_bulk_actions: function() {
		this.table_toolbar = get_table_toolbar(this.table, this.actions, {
			actions: '<%[ Actions ]%>',
			ok: '<%[ OK ]%>'
		});
	}
};

var oUsers = {
	load_user_window: function(username) {
		var title_add = document.getElementById('user_window_title_add');
		var title_edit = document.getElementById('user_window_title_edit');
		var user_field_name = document.getElementById('<%=$this->UserName->ClientID%>');
		var user_field_req = document.getElementById('user_window_required');
		var user_win_type = document.getElementById('<%=$this->UserWindowType->ClientID%>');
		// callback is sent both for new and edit user because there is realized
		// checking if password is allowed to set or not
		var cb = <%=$this->LoadUser->ActiveControl->Javascript%>;
		cb.setCallbackParameter(username);
		cb.dispatch();
		if (username) {
			title_add.style.display = 'none';
			title_edit.style.display = 'inline-block';
			user_field_name.setAttribute('readonly', '');
			user_field_req.style.display = 'none';
			user_win_type.value = 'edit';
		} else {
			title_add.style.display = 'inline-block';
			title_edit.style.display = 'none';
			this.clear_user_window();
			if (user_field_name.hasAttribute('readonly')) {
				user_field_name.removeAttribute('readonly');
			}
			user_field_req.style.display = 'inline';
			user_win_type.value = 'add';
		}
		document.getElementById('user_window').style.display = 'block';
		user_field_name.focus();
	},
	clear_user_window: function() {
		[
			'<%=$this->UserName->ClientID%>',
			'<%=$this->UserLongName->ClientID%>',
			'<%=$this->UserDescription->ClientID%>',
			'<%=$this->UserEmail->ClientID%>',
			'<%=$this->UserPassword->ClientID%>',
			'<%=$this->UserRoles->ClientID%>',
			'<%=$this->UserAPIHost->ClientID%>',
			'<%=$this->UserIps->ClientID%>'
		].forEach(function(id) {
			document.getElementById(id).value = '';
		});
		document.getElementById('<%=$this->UserEnabled->ClientID%>').checked = true;
	},
	load_user_list: function() {
		var cb = <%=$this->UserList->ActiveControl->Javascript%>;
		cb.dispatch();
	},
	load_user_list_cb: function(list) {
		oUserList.data = list;
		oUserList.init();
	},
	save_user_cb: function() {
		document.getElementById('user_window').style.display = 'none';
	}
}

$(function() {
	oUsers.load_user_list();
});
</script>
		<div id="user_window" class="w3-modal">
			<div class="w3-modal-content w3-animate-top w3-card-4">
				<header class="w3-container w3-teal">
					<span onclick="document.getElementById('user_window').style.display = 'none';" class="w3-button w3-display-topright">&times;</span>
					<h2 id="user_window_title_add" style="display: none"><%[ Add user ]%></h2>
					<h2 id="user_window_title_edit" style="display: none"><%[ Edit user ]%></h2>
				</header>
				<div class="w3-container w3-margin-left w3-margin-right w3-text-teal">
					<com:TValidationSummary
						CssClass="field_invalid-summary"
						ValidationGroup="UserGroup"
						AutoUpdate="true"
						Display="Dynamic"
						/>
					<span id="user_window_username_exists" class="error" style="display: none"><ul><li><%[ Username with the given name already exists. ]%></li></ul></span>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserName" Text="<%[ Username: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="UserName"
								AutoPostBack="false"
								MaxLength="100"
								CssClass="w3-input w3-border"
							/>
							<com:TRequiredFieldValidator
								ValidationGroup="UserGroup"
								ControlToValidate="UserName"
								ErrorMessage="<%[ Username field cannot be empty. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
							<com:TRegularExpressionValidator
								ValidationGroup="UserGroup"
								RegularExpression="<%=WebUserConfig::USER_PATTERN%>"
								ControlToValidate="UserName"
								ErrorMessage="<%[ Invalid username value. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
						</div> &nbsp;<i id="user_window_required" class="fa fa-asterisk w3-text-red opt_req" style="display none"></i>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserLongName" Text="<%[ Long name: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="UserLongName"
								AutoPostBack="false"
								MaxLength="100"
								CssClass="w3-input w3-border"
							/>
						</div>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserDescription" Text="<%[ Description: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="UserDescription"
								TextMode="MultiLine"
								Rows="3"
								AutoPostBack="false"
								MaxLength="500"
								CssClass="w3-input w3-border"
							/>
						</div>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserEmail" Text="<%[ E-mail: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="UserEmail"
								AutoPostBack="false"
								MaxLength="500"
								CssClass="w3-input w3-border"
							/>
							<com:TRegularExpressionValidator
								ValidationGroup="UserGroup"
								RegularExpression="<%=WebUserConfig::EMAIL_ADDRESS_PATTERN%>"
								ControlToValidate="UserEmail"
								ErrorMessage="<%[ Invalid e-mail address value. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
						</div>
					</div>
					<div id="user_window_password" class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserPassword" Text="<%[ Password: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="UserPassword"
								TextMode="Password"
								AutoPostBack="false"
								MaxLength="1000"
								CssClass="w3-input w3-border"
							/>
						</div>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserRoles" Text="<%[ Roles: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveListBox
								ID="UserRoles"
								SelectionMode="Multiple"
								Rows="6"
								CssClass="w3-select w3-border"
								AutoPostBack="false"
							/>
							<com:TRequiredFieldValidator
								ValidationGroup="UserGroup"
								ControlToValidate="UserRoles"
								ErrorMessage="<%[ At least one role must be selected. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
							<p class="w3-text-black" style="margin: 0 16px 0 0"><%[ Use CTRL + left-click to multiple item selection ]%></p>
						</div> &nbsp;<i class="fa fa-asterisk w3-text-red opt_req"></i>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserAPIHost" Text="<%[ API host: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveDropDownList
								ID="UserAPIHost"
								CssClass="w3-select w3-border"
								AutoPostBack="false"
							/>
						</div>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="UserEnabled" Text="<%[ Enabled: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveCheckBox
								ID="UserEnabled"
								CssClass="w3-check"
								AutoPostBack="false"
							/>
						</div>
					</div>
					<i class="fas fa-wrench w3-text-black"></i> &nbsp;<a href="javascript:void(0)" onclick="$('#user_window_advanced_options').toggle('fast');" class="w3-text-black"><%[ Advanced options ]%></a>
					<div id="user_window_advanced_options" style="display: none">
						<div class="w3-row w3-section" title="<%[ Comma separated IP addresses. Using asterisk character, there is also possible to provide subnet, for example: 192.168.1.* ]%>">
							<div class="w3-col w3-third"><com:TLabel ForControl="UserIps" Text="<%[ IP address restrictions: ]%>" CssClass="w3-xlarge"/></div>
							<div class="w3-half">
								<com:TActiveTextBox
									ID="UserIps"
									AutoPostBack="false"
									MaxLength="500"
									CssClass="w3-input w3-border"
								/>
								<p class="w3-text-black"><a href="javascript:void(0)" onclick="document.getElementById('<%=$this->UserIps->ClientID%>').value = '<%=$_SERVER['REMOTE_ADDR']%>';"><%[ Set your IP address ]%></a></p>
								<com:TActiveCustomValidator
									ID="UserIpsValidator"
									ValidationGroup="UserGroup"
									ControlToValidate="UserIps"
									OnServerValidate="validateIps"
									Display="Dynamic"
									ErrorMessage="<%[ Invalid IP address restrictions value. This field can have comma separated IP addresses only or subnet addresses like 192.168.1.* ]%>"
									ControlCssClass="field_invalid"
								/>
							</div>
						</div>
					</div>
				</div>
				<footer class="w3-container w3-center">
					<button type="button" class="w3-button w3-red" onclick="document.getElementById('user_window').style.display = 'none';"><i class="fas fa-times"></i> &nbsp;<%[ Cancel ]%></button>
					<com:TActiveLinkButton
						ID="UserSave"
						ValidationGroup="UserGroup"
						CausesValidation="true"
						OnCallback="saveUser"
						CssClass="w3-button w3-section w3-teal w3-padding"
					>
						<i class="fa fa-save"></i> &nbsp;<%[ Save ]%>
					</com:TActiveLinkButton>
					<i id="status_command_loading" class="fa fa-sync w3-spin" style="visibility: hidden;"></i>
				</footer>
			</div>
			<com:TActiveHiddenField ID="UserWindowType" />
		</div>
	</div>
	<div class="w3-container tab_item" id="role_list" style="display: none;">
		<div class="w3-panel">
			<button type="button" id="add_role_btn" class="w3-button w3-green" onclick="oRoles.load_role_window()"><i class="fa fa-plus"></i> &nbsp;<%[ Add new role ]%></a>
		</div>
		<table id="role_list_table" class="w3-table w3-striped w3-hoverable w3-white w3-margin-bottom selectable" style="width: 100%">
			<thead>
				<tr>
					<th></th>
					<th><%[ Role name ]%></th>
					<th class="w3-center"><%[ Long name ]%></th>
					<th class="w3-center"><%[ Description ]%></th>
					<th class="w3-center"># <%[ Users ]%></th>
					<th class="w3-center"><%[ Resources ]%></th>
					<th class="w3-center"><%[ Enabled ]%></th>
					<th class="w3-center"><%[ Action ]%></th>
				</tr>
			</thead>
			<tbody id="role_list_body"></tbody>
			<tfoot>
				<tr>
					<th></th>
					<th><%[ Role name ]%></th>
					<th class="w3-center"><%[ Long name ]%></th>
					<th class="w3-center"><%[ Description ]%></th>
					<th class="w3-center"># <%[ Users ]%></th>
					<th class="w3-center"><%[ Resources ]%></th>
					<th class="w3-center"><%[ Enabled ]%></th>
					<th class="w3-center"><%[ Action ]%></th>
				</tr>
			</tfoot>
		</table>
		<p class="info w3-hide-medium w3-hide-small"><%[ Tip: Use left-click to select table row. Use CTRL + left-click to multiple row selection. Use SHIFT + left-click to add a range of rows to selection. ]%></p>
<com:TCallback ID="RoleList" OnCallback="TemplateControl.setRoleList" />
<com:TCallback ID="LoadRole" OnCallback="TemplateControl.loadRoleWindow" />
<script>
var oRoleList = {
	ids: {
		role_list: 'role_list_table',
		role_list_body: 'role_list_body'
	},
	actions: [
		{
			action: 'remove',
			label: '<%[ Remove ]%>',
			value: 'role',
			callback: <%=$this->RemoveRolesAction->ActiveControl->Javascript%>,
			validate: function(selected) {
				var used_roles = [];
				var predefined_roles = <%=json_encode(array_keys($this->getModule('user_role')->getPreDefinedRoles()))%>;
				var predef_roles = [];
				selected.each(function(v, k) {
					if (predefined_roles.indexOf(v.role) !== -1) {
						predef_roles.push(' - ' + v.role);
					} else if (v.user_count > 0) {
						used_roles.push(' - ' + v.role);
					}
				});
				var emsg = '', msg;
				if (predef_roles.length > 0) {
					msg = '<%[ The following roles are predefined and cannot be removed: %predefined_roles ]%>';
					emsg += msg.replace('%predefined_roles', '<hr />' + predef_roles.join('<br />') + '<hr />');
				}
				if (used_roles.length > 0) {
					msg = '<%[ The following roles are using by users and cannot be removed: %used_roles To remove them, please unassign all users from these roles. ]%>';
					emsg += msg.replace('%used_roles', '<hr />' + used_roles.join('<br />') + '<hr />');
				}
				if (emsg) {
					oBulkActionsModal.set_error(emsg);
					return false;
				}
				return true;
			}
		}
	],
	data: [],
	table: null,
	table_toolbar: null,
	init: function() {
		if (!this.table) {
			this.set_table();
			this.set_bulk_actions();
			this.set_events();
		} else {
			var page = this.table.page();
			this.table.clear().rows.add(oRoleList.data).draw();
			this.table.page(page).draw(false);
			this.set_filters(this.table);
			this.table_toolbar.style.display = 'none';
		}
	},
	set_events: function() {
		document.getElementById(this.ids.role_list).addEventListener('click', function(e) {
			$(function() {
				this.table_toolbar.style.display = this.table.rows({selected: true}).data().length > 0 ? '' : 'none';
			}.bind(this));
		}.bind(this));
	},
	set_table: function() {
		this.table = $('#' + this.ids.role_list).DataTable({
			data: this.data,
			deferRender: true,
			dom: 'lB<"table_toolbar">frtip',
			stateSave: true,
			buttons: [
				'copy', 'csv', 'colvis'
			],
			columns: [
				{
					className: 'details-control',
					orderable: false,
					data: null,
					defaultContent: '<button type="button" class="w3-button w3-blue"><i class="fa fa-angle-down"></i></button>'
				},
				{data: 'role'},
				{data: 'long_name'},
				{
					data: 'description',
					visible: false
				},
				{data: 'user_count'},
				{
					data: 'resources',
					render: function(data, type, row) {
						ret = data;
						if (type == 'display') {
							var span = document.createElement('SPAN');
							span.title = data;
							if (data.length > 40) {
								span.textContent = data.substring(0, 40) + '...';
							} else {
								span.textContent = data;
							}
							ret = span.outerHTML;
						} else {
							ret = data;
						}
						return ret;
					}
				},
				{
					data: 'enabled',
					render: function(data, type, row) {
						var ret;
						if (type == 'display') {
							ret = '';
							if (data == 1) {
								var check = document.createElement('I');
								check.className = 'fas fa-check';
								ret = check.outerHTML;
							}
						} else {
							ret = data;
						}
						return ret;
					}
				},
				{
					data: 'role',
					render: function (data, type, row) {
						var btn_edit = document.createElement('BUTTON');
						btn_edit.className = 'w3-button w3-green';
						btn_edit.type = 'button';
						var i_edit = document.createElement('I');
						i_edit.className = 'fa fa-list-ul';
						var label_edit = document.createTextNode(' <%[ Edit ]%>');
						btn_edit.appendChild(i_edit);
						btn_edit.innerHTML += '&nbsp';
						btn_edit.style.marginRight = '8px';
						btn_edit.appendChild(label_edit);
						btn_edit.setAttribute('onclick', 'oRoles.load_role_window(\'' + data + '\')');
						return btn_edit.outerHTML;
					}
				}
			],
			responsive: {
				details: {
					type: 'column'
				}
			},
			columnDefs: [{
				className: 'control',
				orderable: false,
				targets: 0
			},
			{
				className: 'action_col',
				orderable: false,
				targets: [ 7 ]
			},
			{
				className: "dt-center",
				targets: [ 2, 3, 4, 5, 6, 7 ]
			}],
			select: {
				style:    'os',
				selector: 'td:not(:last-child):not(:first-child)',
				blurable: false
			},
			order: [1, 'asc'],
			initComplete: function () {
				oRoleList.set_filters(this.api());
			}
		});
	},
	set_filters: function(api) {
		api.columns([6]).every(function () {
			var column = this;
			var select = $('<select><option value=""></option></select>')
			.appendTo($(column.footer()).empty())
			.on('change', function () {
				var val = dtEscapeRegex(
					$(this).val()
				);
				column
				.search(val ? '^' + val + '$' : '', true, false)
				.draw();
			});
			if (column[0][0] == 6) { // Enabled column
				column.data().unique().sort().each(function (d, j) {
					var ds = '';
					if (d === '1') {
						ds = '<%[ Enabled ]%>';
					} else if (d === '0') {
						ds = '<%[ Disabled ]%>';
					}
					if (column.search() == '^' + dtEscapeRegex(d) + '$') {
						select.append('<option value="' + d + '" title="' + ds + '" selected>' + ds + '</option>');
					} else if (ds) {
						select.append('<option value="' + d + '" title="' + ds + '">' + ds + '</option>');
					}
				});
			}
		});
	},
	set_bulk_actions: function() {
		this.table_toolbar = get_table_toolbar(this.table, this.actions, {
			actions: '<%[ Actions ]%>',
			ok: '<%[ OK ]%>'
		});
	}
};

var oRoles = {
	load_role_window: function(role) {
		var title_add = document.getElementById('role_window_title_add');
		var title_edit = document.getElementById('role_window_title_edit');
		var role_field_name = document.getElementById('<%=$this->Role->ClientID%>');
		var role_field_req = document.getElementById('role_window_required');
		var role_win_type = document.getElementById('<%=$this->RoleWindowType->ClientID%>');
		var cb = <%=$this->LoadRole->ActiveControl->Javascript%>;
		cb.setCallbackParameter(role);
		cb.dispatch();
		if (role) {
			title_add.style.display = 'none';
			title_edit.style.display = 'inline-block';
			role_field_name.setAttribute('readonly', '');
			role_field_req.style.display = 'none';
			role_win_type.value = 'edit';
		} else {
			title_add.style.display = 'inline-block';
			title_edit.style.display = 'none';
			this.clear_role_window();
			if (role_field_name.hasAttribute('readonly')) {
				role_field_name.removeAttribute('readonly');
			}
			role_field_req.style.display = 'inline';
			role_win_type.value = 'add';
		}
		document.getElementById('role_window_role_exists').style.display = 'none';
		document.getElementById('role_window').style.display = 'block';
		if (!role) {
			role_field_name.focus();
		}
	},
	clear_role_window: function() {
		[
			'<%=$this->Role->ClientID%>',
			'<%=$this->RoleLongName->ClientID%>',
			'<%=$this->RoleDescription->ClientID%>',
			'<%=$this->RoleResources->ClientID%>',
		].forEach(function(id) {
			document.getElementById(id).value = '';
		});
		document.getElementById('<%=$this->RoleEnabled->ClientID%>').checked = true;
	},
	load_role_list: function() {
		var cb = <%=$this->RoleList->ActiveControl->Javascript%>;
		cb.dispatch();
	},
	load_role_list_cb: function(list) {
		oRoleList.data = list;
		oRoleList.init();
	},
	save_role_cb: function() {
		document.getElementById('role_window').style.display = 'none';
	}
}

$(function() {
	oRoles.load_role_list();
});
</script>
		<div id="role_window" class="w3-modal">
			<div class="w3-modal-content w3-animate-top w3-card-4">
				<header class="w3-container w3-teal">
					<span onclick="document.getElementById('role_window').style.display = 'none';" class="w3-button w3-display-topright">&times;</span>
					<h2 id="role_window_title_add" style="display: none"><%[ Add role ]%></h2>
					<h2 id="role_window_title_edit" style="display: none"><%[ Edit role ]%></h2>
				</header>
				<div class="w3-container w3-margin-left w3-margin-right w3-text-teal">
					<com:TValidationSummary
						CssClass="field_invalid-summary"
						ValidationGroup="RoleGroup"
						AutoUpdate="true"
						Display="Dynamic"
						/>
					<span id="role_window_role_exists" class="error" style="display: none"><ul><li><%[ Role with the given name already exists. ]%></li></ul></span>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="Role" Text="<%[ Role: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="Role"
								AutoPostBack="false"
								MaxLength="100"
								CssClass="w3-input w3-border"
							/>
							<com:TRequiredFieldValidator
								ValidationGroup="RoleGroup"
								ControlToValidate="Role"
								ErrorMessage="<%[ Role field cannot be empty. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
							<com:TRegularExpressionValidator
								ValidationGroup="RoleGroup"
								RegularExpression="<%=WebRoleConfig::ROLE_PATTERN%>"
								ControlToValidate="Role"
								ErrorMessage="<%[ Invalid role value. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
						</div> &nbsp;<i id="role_window_required" class="fa fa-asterisk w3-text-red opt_req" style="display none"></i>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="RoleLongName" Text="<%[ Long name: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="RoleLongName"
								AutoPostBack="false"
								MaxLength="100"
								CssClass="w3-input w3-border"
							/>
						</div>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="RoleDescription" Text="<%[ Description: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveTextBox
								ID="RoleDescription"
								TextMode="MultiLine"
								Rows="3"
								AutoPostBack="false"
								MaxLength="500"
								CssClass="w3-input w3-border"
							/>
						</div>
					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="RoleResources" Text="<%[ Resources: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveListBox
								ID="RoleResources"
								SelectionMode="Multiple"
								Rows="6"
								CssClass="w3-select w3-border"
								AutoPostBack="false"
							/>
							<com:TRequiredFieldValidator
								ValidationGroup="RoleGroup"
								ControlToValidate="RoleResources"
								ErrorMessage="<%[ At least one resource must be selected. ]%>"
								ControlCssClass="field_invalid"
								Display="None"
							/>
							<p class="w3-text-black" style="margin: 0 16px 0 0"><%[ Use CTRL + left-click to multiple item selection ]%></p>
						</div> &nbsp;<i class="fa fa-asterisk w3-text-red opt_req"></i>

					</div>
					<div class="w3-row w3-section">
						<div class="w3-col w3-third"><com:TLabel ForControl="RoleEnabled" Text="<%[ Enabled: ]%>" CssClass="w3-xlarge"/></div>
						<div class="w3-half">
							<com:TActiveCheckBox
								ID="RoleEnabled"
								CssClass="w3-check"
								AutoPostBack="false"
							/>
						</div>
					</div>
				</div>
				<com:TActiveLabel
					ID="PreDefinedRoleMsg"
					CssClass="w3-margin-left"
					Display="None"
				>
					<%[ This is native predefined role, that cannot be changed. For having custom roles please use the button to add new role. ]%>
				</com:TActiveLabel>
				<footer class="w3-container w3-center w3-padding">
					<button type="button" class="w3-button w3-red" onclick="document.getElementById('role_window').style.display = 'none';"><i class="fas fa-times"></i> &nbsp;<%[ Cancel ]%></button>
					<com:TActiveLinkButton
						ID="RoleSave"
						ValidationGroup="RoleGroup"
						CausesValidation="true"
						OnCallback="saveRole"
						CssClass="w3-button w3-section w3-teal"
					>
						<i class="fa fa-save"></i> &nbsp;<%[ Save ]%>
					</com:TActiveLinkButton>
					<i id="status_command_loading" class="fa fa-sync w3-spin" style="visibility: hidden;"></i>
				</footer>
			</div>
			<com:TActiveHiddenField ID="RoleWindowType" />
		</div>
	</div>
<script>
/**
 * Defne bulk actions output id here because expression tags (< % = % >) cannot
 * be defined in the TCallback ClientSide properties.
 */
var bulk_actions_output_id = '<%=$this->SourceTemplateControl->BulkActions->BulkActionsOutput->ClientID%>';
</script>
	<com:TCallback ID="RemoveRolesAction" OnCallback="TemplateControl.removeRoles" />
	<com:Application.Web.Portlets.BulkActionsModal ID="BulkActions" />
</com:TContent>
